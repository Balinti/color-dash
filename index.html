<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Color Dash - Free HTML5 Game</title>
<meta name="description" content="Play Color Dash - Run through color gates matching your current color. Tap to switch between colors. Speed increases every 10 points.">
<meta name="theme-color" content="#1a1a2e">
<meta property="og:type" content="website">
<meta property="og:title" content="Color Dash - Free HTML5 Game">
<meta property="og:description" content="Run through color gates matching your current color. Tap to burst-dash and switch colors. How far can you go?">
<meta property="og:url" content="https://balinti.github.io/color-dash/">
<meta property="og:image" content="https://balinti.github.io/color-dash/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Color Dash - Free HTML5 Game">
<meta name="twitter:description" content="Run through color gates matching your current color. Tap to burst-dash and switch colors. How far can you go?">
<meta name="twitter:image" content="https://balinti.github.io/color-dash/og-image.png">
<link rel="canonical" href="https://balinti.github.io/color-dash/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4099346100621490" crossorigin="anonymous"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden;background:#0f0f23;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#e0e0e0}
#game-wrap{display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:0}
#canvas-container{position:relative;width:100%;max-width:420px;max-height:750px;touch-action:none;-webkit-tap-highlight-color:transparent;flex-shrink:0}
canvas{display:block;width:100%;height:100%;border-radius:8px}
#seo-content{max-width:420px;width:100%;margin:20px auto;padding:0 16px 40px}
#seo-content h2{font-size:1.1rem;color:#c0c0ff;margin:18px 0 8px}
#seo-content p,#seo-content li{font-size:0.88rem;color:#aaa;line-height:1.5}
#seo-content ul{padding-left:20px;margin:4px 0}
#seo-content details{margin:8px 0}
#seo-content summary{cursor:pointer;color:#c0c0ff;font-size:0.95rem}
</style>
</head>
<body>
<div id="game-wrap">
<div id="canvas-container"><canvas id="gc"></canvas></div>
<div id="seo-content">
<h2>How to Play</h2>
<p>Your runner automatically follows the lane matching its current color: Red&rarr;Left, Blue&rarr;Center, Yellow&rarr;Right. Gates scroll toward you in pairs across two lanes.</p>
<ul>
<li><strong>Tap / Space / Enter</strong> &mdash; Burst-dash forward and cycle to the next color.</li>
<li>Pass through gates that match your color to score.</li>
<li>Perfect timing doubles that gate&rsquo;s points.</li>
<li>Collect shards for bonus points (golden shards are worth 25!).</li>
</ul>
<h2>Tips</h2>
<ul>
<li>Watch for Lock Zones (pulsing red bands). Bursting inside one is instant death.</li>
<li>Build your streak &mdash; every 5 gates in a row raises your multiplier (max &times;12).</li>
<li>Bursting resets your multiplier unless the next gate pass is Perfect.</li>
<li>Colorblind-friendly shapes mark each color: triangles for Red, circles for Blue, squares for Yellow.</li>
</ul>
<details><summary>FAQ</summary>
<p><strong>What are Lock Zones?</strong> Red-striped bands that appear before some gates at higher scores. If you burst while one is on-screen near you, you die instantly.</p>
<p><strong>How does the multiplier work?</strong> Each gate passed adds to your streak. Every 5-streak bump raises your multiplier by 1 (up to &times;12). Bursting normally resets it, but a Perfect pass preserves it.</p>
<p><strong>Is there a max speed?</strong> Speed caps at 520 px/s so the game stays playable.</p>
</details>
</div>
</div>
<script>
'use strict';
(()=>{
const canvas=document.getElementById('gc');
const ctx=canvas.getContext('2d');
const container=document.getElementById('canvas-container');

const COLORS=['#e74c3c','#3498db','#f1c40f'];
const COLOR_NAMES=['Red','Blue','Yellow'];
const MAX_W=420,MAX_H=750;
const TRACK_PAD_X=24,TRACK_TOP=90,TRACK_BOTTOM_PAD=40;
const PLAYER_Y_OFFSET=150,PLAYER_R=16;
const GATE_H=18,PAIR_GAP=34;
const BURST_DUR=0.25,BURST_MUL=1.45;
const LANE_MAGNET_K=26;
const LOCK_THICKNESS=70;
const SHARD_R=10;

let W,H,dpr;
let state='start';
let score,best,mult,streak,perfectCount,totalGates;
let player,gates,shards,particles;
let spawnDistAcc,timeScale,hitStopT;
let shakeT,shakeAmp;
let deathCause,maxMult;
let burstSinceLastGate;
let challengeScore=0;
let lastTime=0;
let shareBtn=null;

try{
  const u=new URLSearchParams(location.search);
  if(u.has('challenge'))challengeScore=parseInt(u.get('challenge'))||0;
}catch(e){}

best=parseInt(localStorage.getItem('cd_best'))||0;

function resize(){
  const cssW=Math.min(window.innerWidth,MAX_W);
  const cssH=Math.min(window.innerHeight,MAX_H);
  container.style.width=cssW+'px';
  container.style.height=cssH+'px';
  dpr=Math.min(window.devicePixelRatio||1,2);
  canvas.width=Math.floor(cssW*dpr);
  canvas.height=Math.floor(cssH*dpr);
  W=cssW;H=cssH;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize',resize);
resize();

function trackW(){return W-TRACK_PAD_X*2}
function laneX(i){return TRACK_PAD_X+trackW()*((2*i+1)/6)}
function sweetY(){return H-PLAYER_Y_OFFSET}

function getSpeed(){
  return Math.min(520,260+6.0*score+18*Math.sqrt(score));
}
function curSetSpacing(){return Math.max(150,Math.min(260,260-0.9*score))}
function curPerfectWindow(){return Math.max(10,Math.min(22,22-0.06*score))}
function curPLock(){return Math.max(0,Math.min(0.55,(score-20)/80))}
function curPShard(){return Math.max(0.20,Math.min(0.42,0.20+0.0025*score))}
function curPGolden(){return score>=100?0.02:0}

function pickLanePair(){
  if(score<=5){
    return Math.random()<0.5?[0,1]:[1,2];
  }
  if(score<=20){
    const r=Math.random();
    if(r<0.2)return[0,2];
    return r<0.6?[0,1]:[1,2];
  }
  const r=Math.random();
  if(r<0.333)return[0,1];
  if(r<0.666)return[1,2];
  return[0,2];
}

function isSurvivable(pair,colors,pc){
  // Player is magneted to lane=pc. If no gate occupies lane pc, player passes safely.
  if(!pair.includes(pc))return true;
  // If a gate is in lane pc and matches color pc, player passes through it.
  for(let i=0;i<pair.length;i++){
    if(pair[i]===pc&&colors[i]===pc)return true;
  }
  // If player bursts immediately: new color = (pc+1)%3, new lane = (pc+1)%3
  const nc=(pc+1)%3;
  if(!pair.includes(nc))return true;
  for(let i=0;i<pair.length;i++){
    if(pair[i]===nc&&colors[i]===nc)return true;
  }
  return false;
}

function spawnGateSet(){
  let pair,colors;
  let attempts=0;
  do{
    pair=pickLanePair();
    colors=[Math.floor(Math.random()*3),Math.floor(Math.random()*3)];
    attempts++;
  }while(!isSurvivable(pair,colors,player.color)&&attempts<30);

  const hasLock=Math.random()<curPLock();
  const baseY=-40;

  for(let i=0;i<pair.length;i++){
    const g={
      lane:pair[i],
      x:laneX(pair[i]),
      y:baseY-(i===1?PAIR_GAP:0),
      w:(trackW()/3)-18,
      h:GATE_H,
      color:colors[i],
      passed:false,
      lock:hasLock&&i===0,
      lockTopOffset:-140
    };
    gates.push(g);
  }

  if(Math.random()<curPShard()){
    const sLane=pair[Math.floor(Math.random()*pair.length)];
    shards.push({
      x:laneX(sLane),
      y:baseY+60,
      r:SHARD_R,
      golden:Math.random()<curPGolden(),
      collected:false
    });
  }
}

function spawnParticles(x,y,count,hue,mode){
  for(let i=0;i<count;i++){
    const angle=-Math.PI/2+((Math.random()-0.5)*Math.PI*0.8);
    const spd=80+Math.random()*200;
    particles.push({
      x,y,
      vx:Math.cos(angle)*spd*(0.5+Math.random()),
      vy:Math.sin(angle)*spd*(0.5+Math.random()),
      life:0.4+Math.random()*0.5,
      maxLife:0.4+Math.random()*0.5,
      size:2+Math.random()*4,
      hue:hue+Math.random()*30-15,
      mode:mode||'normal'
    });
  }
}

function spawnRing(x,y,hue){
  for(let i=0;i<16;i++){
    const angle=(Math.PI*2/16)*i;
    const spd=150+Math.random()*80;
    particles.push({
      x,y,
      vx:Math.cos(angle)*spd,
      vy:Math.sin(angle)*spd,
      life:0.3+Math.random()*0.2,
      maxLife:0.5,
      size:3+Math.random()*3,
      hue,
      mode:'ring'
    });
  }
}

function triggerShake(amp,dur){shakeAmp=amp;shakeT=dur}
function triggerHitStop(scale,dur){timeScale=scale;hitStopT=dur}

function drawColorPattern(cx,cy,r,ci,a){
  ctx.globalAlpha=a||0.55;
  ctx.strokeStyle='#fff';ctx.fillStyle='#fff';ctx.lineWidth=1.5;
  if(ci===0){
    ctx.beginPath();
    ctx.moveTo(cx,cy-r*0.55);ctx.lineTo(cx-r*0.5,cy+r*0.4);ctx.lineTo(cx+r*0.5,cy+r*0.4);ctx.closePath();ctx.stroke();
  }else if(ci===1){
    ctx.beginPath();ctx.arc(cx,cy,r*0.4,0,Math.PI*2);ctx.stroke();
  }else{
    const s=r*0.5;ctx.strokeRect(cx-s/2,cy-s/2,s,s);
  }
  ctx.globalAlpha=1;
}

function drawGatePattern(gx,gy,gw,gh,ci){
  ctx.globalAlpha=0.4;ctx.strokeStyle='#fff';ctx.fillStyle='#fff';ctx.lineWidth=1;
  const cy=gy+gh/2;
  if(ci===0){
    for(let i=-2;i<=2;i++){const sx=gx+i*(gw/6);ctx.beginPath();ctx.moveTo(sx,gy);ctx.lineTo(sx+4,gy+gh);ctx.stroke();}
  }else if(ci===1){
    for(let i=-1;i<=1;i++){ctx.beginPath();ctx.arc(gx+i*(gw/4),cy,3,0,Math.PI*2);ctx.fill();}
  }else{
    for(let i=-1;i<=1;i++){ctx.strokeRect(gx+i*(gw/4)-4,cy-4,8,8);}
  }
  ctx.globalAlpha=1;
}

function initGame(){
  score=0;mult=1;streak=0;perfectCount=0;totalGates=0;maxMult=1;
  player={x:laneX(1),y:sweetY(),color:1,burstT:0,targetLane:1};
  gates=[];shards=[];particles=[];
  spawnDistAcc=0;timeScale=1;hitStopT=0;
  shakeT=0;shakeAmp=0;deathCause='';
  burstSinceLastGate=false;
  // Pre-spawn a few gate sets
  for(let i=0;i<4;i++){
    spawnGateSet();
    // Spread them out vertically
    const spread=120+i*curSetSpacing();
    for(const g of gates){
      if(g.y<0)g.y-=spread;
    }
    for(const s of shards){
      if(s.y<100)s.y-=spread;
    }
  }
  spawnDistAcc=0;
}

function isInLockZone(){
  const sy=sweetY();
  for(const g of gates){
    if(!g.lock||g.passed)continue;
    const lockTop=g.y+g.lockTopOffset;
    const lockBot=lockTop+LOCK_THICKNESS;
    if(lockBot>sy-80&&lockTop<sy+40)return true;
  }
  return false;
}

function doBurst(){
  if(state==='start'){state='playing';initGame();return}
  if(state==='gameover'){state='start';return}
  if(state!=='playing')return;

  if(isInLockZone()){die('Burst in Lock Zone');return}

  player.burstT=BURST_DUR;
  player.color=(player.color+1)%3;
  player.targetLane=player.color;
  burstSinceLastGate=true;
}

let inputLocked=false;
canvas.addEventListener('pointerdown',(e)=>{
  e.preventDefault();
  if(state==='gameover'&&shareBtn){
    const rect=canvas.getBoundingClientRect();
    const sx=W/rect.width,sy=H/rect.height;
    const mx=(e.clientX-rect.left)*sx,my=(e.clientY-rect.top)*sy;
    if(mx>=shareBtn.x&&mx<=shareBtn.x+shareBtn.w&&my>=shareBtn.y&&my<=shareBtn.y+shareBtn.h){
      doShare();return;
    }
  }
  doBurst();
});
document.addEventListener('keydown',(e)=>{
  if(e.code==='Space'||e.code==='Enter'){e.preventDefault();doBurst();}
});

function die(cause){
  deathCause=cause;
  if(score>best){best=score;localStorage.setItem('cd_best',best)}
  spawnParticles(player.x,player.y,60,0,'death');
  triggerShake(14,0.25);
  triggerHitStop(0,0.12);
  // State transitions after freeze
  setTimeout(()=>{state='gameover';timeScale=1},130);
}

function doShare(){
  const url='https://balinti.github.io/color-dash/?challenge='+score;
  const text='I scored '+score+' in Color Dash! Can you beat me?';
  if(navigator.share){
    navigator.share({title:'Color Dash',text,url}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text+' '+url).then(()=>{
      alert('Score link copied to clipboard!');
    }).catch(()=>{prompt('Copy this link:',text+' '+url)});
  }
}

function circleAABB(cx,cy,cr,rx,ry,rw,rh){
  const nx=Math.max(rx,Math.min(cx,rx+rw));
  const ny=Math.max(ry,Math.min(cy,ry+rh));
  const dx=cx-nx,dy=cy-ny;
  return(dx*dx+dy*dy)<(cr*cr);
}

function nearestLane(x){
  let b=0,bd=Infinity;
  for(let i=0;i<3;i++){const d=Math.abs(x-laneX(i));if(d<bd){bd=d;b=i;}}
  return b;
}

function update(rawDt){
  if(state!=='playing')return;
  if(hitStopT>0){hitStopT-=rawDt;if(hitStopT<=0)timeScale=1}
  const dt=rawDt*timeScale;
  if(dt<=0.0001)return;

  const speed=getSpeed()*(player.burstT>0?BURST_MUL:1);

  if(player.burstT>0)player.burstT=Math.max(0,player.burstT-dt);

  // Lane magnet
  const tx=laneX(player.targetLane);
  player.x+=(tx-player.x)*(1-Math.exp(-LANE_MAGNET_K*dt));

  // Spawn
  spawnDistAcc+=speed*dt;
  while(spawnDistAcc>=curSetSpacing()){
    spawnDistAcc-=curSetSpacing();
    spawnGateSet();
  }

  // Move gates & shards down
  for(const g of gates)g.y+=speed*dt;
  for(const s of shards)s.y+=speed*dt;

  // Gate collision
  const sy=sweetY();
  const pw=curPerfectWindow();
  for(const g of gates){
    if(g.passed)continue;
    if(g.y>H+50){g.passed=true;continue}
    const gx=g.x-g.w/2;
    if(Math.abs(g.y-sy)<60){
      if(circleAABB(player.x,player.y,PLAYER_R,gx,g.y,g.w,g.h)){
        if(g.color!==player.color){die('Wrong Gate');return}
        g.passed=true;totalGates++;
        const isPerfect=Math.abs(g.y-sy)<pw;
        let pts=mult;
        if(isPerfect){
          perfectCount++;pts+=mult;
          spawnParticles(player.x,player.y,22,50,'perfect');
          spawnRing(player.x,player.y,50);
          triggerShake(6,0.10);triggerHitStop(0.15,0.05);
        }else{
          const hue=g.color===0?0:g.color===1?210:50;
          spawnParticles(player.x,player.y,14,hue,'normal');
        }
        if(!isPerfect&&burstSinceLastGate){mult=1;streak=0}
        burstSinceLastGate=false;
        streak++;
        if(streak%5===0&&mult<12)mult++;
        if(mult>maxMult)maxMult=mult;
        score+=pts;
      }
    }
    // Missed gate: gate matches player color, is in player's lane, passed below
    if(!g.passed&&g.y>sy+40){
      if(g.color===player.color&&g.lane===nearestLane(player.x)){
        g.passed=true;die('Missed Gate');return;
      }
    }
  }

  // Shard collision
  for(const s of shards){
    if(s.collected)continue;
    if(s.y>H+50){s.collected=true;continue}
    const dx=player.x-s.x,dy=player.y-s.y;
    if(dx*dx+dy*dy<(PLAYER_R+s.r)*(PLAYER_R+s.r)){
      s.collected=true;
      score+=s.golden?25:5;
      spawnParticles(s.x,s.y,18,s.golden?45:180,'shard');
      triggerShake(4,0.08);
    }
  }

  // Particles
  for(const p of particles){
    p.x+=p.vx*dt;p.y+=p.vy*dt;
    p.vy+=400*dt;p.vx*=(1-2*dt);p.life-=dt;
  }

  // Cull
  gates=gates.filter(g=>!g.passed&&g.y<H+100);
  shards=shards.filter(s=>!s.collected&&s.y<H+100);
  particles=particles.filter(p=>p.life>0);
}

// --- Drawing ---
function roundRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function draw(){
  ctx.save();
  let sx=0,sy=0;
  if(shakeT>0){
    const f=shakeT/0.25;
    sx=(Math.random()-0.5)*2*shakeAmp*f;
    sy=(Math.random()-0.5)*2*shakeAmp*f;
  }
  ctx.translate(sx,sy);

  // BG
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#0f0f23');grad.addColorStop(1,'#1a1a3e');
  ctx.fillStyle=grad;ctx.fillRect(-20,-20,W+40,H+40);

  // Track
  ctx.fillStyle='rgba(255,255,255,0.03)';
  ctx.fillRect(TRACK_PAD_X,TRACK_TOP,trackW(),H-TRACK_TOP-TRACK_BOTTOM_PAD);
  ctx.strokeStyle='rgba(255,255,255,0.08)';ctx.lineWidth=1;
  for(let i=1;i<3;i++){
    const x=TRACK_PAD_X+trackW()*(i/3);
    ctx.beginPath();ctx.moveTo(x,TRACK_TOP);ctx.lineTo(x,H-TRACK_BOTTOM_PAD);ctx.stroke();
  }
  // Lane labels
  ctx.font='10px sans-serif';ctx.textAlign='center';ctx.globalAlpha=0.3;
  for(let i=0;i<3;i++){
    ctx.fillStyle=COLORS[i];
    ctx.fillText(COLOR_NAMES[i],laneX(i),H-TRACK_BOTTOM_PAD+14);
  }
  ctx.globalAlpha=1;

  if(state==='start')drawStart();
  else if(state==='playing')drawPlay();
  else if(state==='gameover')drawPlay(),drawGameOver();

  ctx.restore();
}

function drawStart(){
  ctx.textAlign='center';
  ctx.font='bold 38px sans-serif';ctx.fillStyle='#fff';
  ctx.fillText('COLOR DASH',W/2,H*0.28);
  ctx.font='16px sans-serif';ctx.fillStyle='#aaa';
  ctx.fillText('Commit & Burst',W/2,H*0.28+30);

  ctx.font='13px sans-serif';ctx.fillStyle='#888';
  ['Tap to BURST (dash + switch color)',
   'Match your color to gates to score',
   'Avoid wrong gates & lock zones'].forEach((l,i)=>{
    ctx.fillText(l,W/2,H*0.45+i*22);
  });

  for(let i=0;i<3;i++){
    const x=W/2+(i-1)*60,y=H*0.58;
    ctx.fillStyle=COLORS[i];ctx.beginPath();ctx.arc(x,y,12,0,Math.PI*2);ctx.fill();
    drawColorPattern(x,y,12,i,0.8);
    ctx.font='10px sans-serif';ctx.fillStyle='#aaa';ctx.fillText(COLOR_NAMES[i],x,y+24);
  }

  if(challengeScore>0){
    ctx.font='bold 16px sans-serif';ctx.fillStyle='#ffd700';
    ctx.fillText('Beat '+challengeScore+'!',W/2,H*0.68);
  }
  if(best>0){
    ctx.font='13px sans-serif';ctx.fillStyle='#666';
    ctx.fillText('Best: '+best,W/2,H*0.74);
  }

  const pulse=0.5+0.3*Math.sin(performance.now()*0.004);
  ctx.globalAlpha=pulse;ctx.font='bold 18px sans-serif';ctx.fillStyle='#fff';
  ctx.fillText('TAP TO START',W/2,H*0.84);ctx.globalAlpha=1;
}

function drawPlay(){
  // Lock zones
  for(const g of gates){
    if(!g.lock||g.passed)continue;
    const lt=g.y+g.lockTopOffset;
    if(lt+LOCK_THICKNESS<0||lt>H)continue;
    ctx.fillStyle='rgba(255,30,30,0.08)';
    ctx.fillRect(TRACK_PAD_X,lt,trackW(),LOCK_THICKNESS);
    ctx.strokeStyle='rgba(255,50,50,0.2)';ctx.lineWidth=1;
    for(let sx=TRACK_PAD_X;sx<TRACK_PAD_X+trackW();sx+=12){
      ctx.beginPath();ctx.moveTo(sx,lt);ctx.lineTo(sx+6,lt+LOCK_THICKNESS);ctx.stroke();
    }
    const pulse=0.3+0.2*Math.sin(performance.now()*0.006);
    ctx.strokeStyle=`rgba(255,50,50,${pulse})`;ctx.lineWidth=2;
    ctx.strokeRect(TRACK_PAD_X,lt,trackW(),LOCK_THICKNESS);
  }

  // Gates
  for(const g of gates){
    if(g.passed||g.y<-50||g.y>H+50)continue;
    const gx=g.x-g.w/2;
    ctx.fillStyle=COLORS[g.color];ctx.globalAlpha=0.85;
    roundRect(gx,g.y,g.w,g.h,6);ctx.fill();
    ctx.globalAlpha=1;
    ctx.shadowColor=COLORS[g.color];ctx.shadowBlur=10;ctx.fill();ctx.shadowBlur=0;
    drawGatePattern(g.x,g.y,g.w,g.h,g.color);
  }

  // Shards
  for(const s of shards){
    if(s.collected||s.y<-20||s.y>H+20)continue;
    ctx.save();ctx.translate(s.x,s.y);ctx.rotate(performance.now()*0.003);
    ctx.fillStyle=s.golden?'#ffd700':'#7fdbff';
    ctx.shadowColor=ctx.fillStyle;ctx.shadowBlur=s.golden?12:8;
    ctx.beginPath();ctx.moveTo(0,-s.r);ctx.lineTo(s.r*0.6,0);ctx.lineTo(0,s.r);ctx.lineTo(-s.r*0.6,0);ctx.closePath();ctx.fill();
    ctx.shadowBlur=0;ctx.restore();
  }

  // Player
  ctx.save();ctx.translate(player.x,player.y);
  if(player.burstT>0){
    const t=player.burstT/BURST_DUR;
    ctx.globalAlpha=t*0.4;ctx.fillStyle=COLORS[player.color];
    ctx.beginPath();ctx.arc(0,0,PLAYER_R+10+10*(1-t),0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
  }
  ctx.fillStyle=COLORS[player.color];ctx.shadowColor=COLORS[player.color];ctx.shadowBlur=15;
  ctx.beginPath();ctx.arc(0,0,PLAYER_R,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  ctx.strokeStyle='rgba(255,255,255,0.6)';ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(0,0,PLAYER_R,0,Math.PI*2);ctx.stroke();
  drawColorPattern(0,0,PLAYER_R,player.color,0.7);
  ctx.restore();

  // Particles
  for(const p of particles){
    const a=Math.max(0,p.life/p.maxLife);
    if(p.mode==='perfect'||p.mode==='ring'||p.mode==='shard')ctx.globalCompositeOperation='lighter';
    ctx.globalAlpha=a;ctx.fillStyle=`hsl(${p.hue},80%,60%)`;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size*a,0,Math.PI*2);ctx.fill();
    ctx.globalCompositeOperation='source-over';ctx.globalAlpha=1;
  }

  // HUD
  ctx.textAlign='left';ctx.font='bold 22px sans-serif';ctx.fillStyle='#fff';
  ctx.fillText(''+score,TRACK_PAD_X,36);
  ctx.font='11px sans-serif';ctx.fillStyle='#888';
  ctx.fillText('BEST: '+best,TRACK_PAD_X,54);
  ctx.textAlign='right';
  if(mult>1){ctx.font='bold 18px sans-serif';ctx.fillStyle='#ffd700';ctx.fillText('\u00d7'+mult,W-TRACK_PAD_X,36)}
  ctx.font='11px sans-serif';ctx.fillStyle='#888';
  ctx.fillText('STREAK: '+streak,W-TRACK_PAD_X,54);
  ctx.textAlign='center';ctx.fillStyle=COLORS[player.color];ctx.font='bold 12px sans-serif';
  ctx.fillText(COLOR_NAMES[player.color].toUpperCase(),W/2,36);
  ctx.beginPath();ctx.arc(W/2,48,5,0,Math.PI*2);ctx.fill();
}

function drawGameOver(){
  ctx.fillStyle='rgba(0,0,0,0.65)';ctx.fillRect(0,0,W,H);
  ctx.textAlign='center';

  ctx.font='bold 30px sans-serif';ctx.fillStyle='#e74c3c';
  ctx.fillText('GAME OVER',W/2,H*0.22);
  ctx.font='14px sans-serif';ctx.fillStyle='#ff6b6b';
  ctx.fillText(deathCause,W/2,H*0.28);

  ctx.font='bold 48px sans-serif';ctx.fillStyle='#fff';
  ctx.fillText(''+score,W/2,H*0.40);
  ctx.font='14px sans-serif';ctx.fillStyle='#888';ctx.fillText('SCORE',W/2,H*0.43);

  if(score>=best&&score>0){
    ctx.font='bold 16px sans-serif';ctx.fillStyle='#ffd700';ctx.fillText('NEW BEST!',W/2,H*0.48);
  }else{
    ctx.font='13px sans-serif';ctx.fillStyle='#666';ctx.fillText('Best: '+best,W/2,H*0.48);
  }

  if(score>0&&score<best&&best-score<=3){
    ctx.font='13px sans-serif';ctx.fillStyle='#ffa500';
    ctx.fillText('So close! Just '+(best-score)+' away from your best!',W/2,H*0.52);
  }

  const statsY=H*0.58;
  ctx.font='12px sans-serif';ctx.fillStyle='#aaa';
  const perfPct=totalGates>0?Math.round((perfectCount/totalGates)*100):0;
  ctx.fillText('Perfect: '+perfPct+'%',W/2-60,statsY);
  ctx.fillText('Max \u00d7'+maxMult,W/2+60,statsY);

  if(challengeScore>0){
    ctx.font='bold 14px sans-serif';
    if(score>=challengeScore){ctx.fillStyle='#2ecc71';ctx.fillText('Challenge beaten!',W/2,statsY+24)}
    else{ctx.fillStyle='#e67e22';ctx.fillText('Challenge: '+challengeScore+' (need '+(challengeScore-score)+' more)',W/2,statsY+24)}
  }

  // Share button
  const bw=140,bh=36,by=H*0.72;
  ctx.fillStyle='#3498db';roundRect(W/2-bw/2,by-bh/2,bw,bh,8);ctx.fill();
  ctx.font='bold 14px sans-serif';ctx.fillStyle='#fff';ctx.fillText('SHARE',W/2,by+5);
  shareBtn={x:W/2-bw/2,y:by-bh/2,w:bw,h:bh};

  const pulse=0.5+0.3*Math.sin(performance.now()*0.004);
  ctx.globalAlpha=pulse;ctx.font='bold 16px sans-serif';ctx.fillStyle='#fff';
  ctx.fillText('TAP TO RETRY',W/2,H*0.86);ctx.globalAlpha=1;
}

function loop(time){
  requestAnimationFrame(loop);
  if(!lastTime){lastTime=time;return}
  let rawDt=(time-lastTime)/1000;
  lastTime=time;
  if(rawDt>0.1)rawDt=0.1;
  if(shakeT>0)shakeT-=rawDt;
  update(rawDt);
  draw();
}
requestAnimationFrame(loop);
})();
</script>
</body>
</html>
